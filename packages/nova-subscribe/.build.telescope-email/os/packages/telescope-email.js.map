{"version":3,"file":"/packages/telescope-email.js","sources":["telescope-email/lib/server/email.js","telescope-email/lib/server/routes.js","telescope-email/lib/server/templates/emailAccountApproved.handlebars","telescope-email/lib/server/templates/emailInvite.handlebars","telescope-email/lib/server/templates/emailNewComment.handlebars","telescope-email/lib/server/templates/emailNewPost.handlebars","telescope-email/lib/server/templates/emailNewReply.handlebars","telescope-email/lib/server/templates/emailNewUser.handlebars","telescope-email/lib/server/templates/emailTest.handlebars","telescope-email/lib/server/templates/emailWrapper.handlebars","telescope-email//Users/sacha/Dev/Telescope/packages/telescope-blank/i18n/de.i18n.json","telescope-email//Users/sacha/Dev/Telescope/packages/telescope-blank/i18n/en.i18n.json","telescope-email//Users/sacha/Dev/Telescope/packages/telescope-blank/i18n/es.i18n.json","telescope-email//Users/sacha/Dev/Telescope/packages/telescope-blank/i18n/fr.i18n.json","telescope-email//Users/sacha/Dev/Telescope/packages/telescope-blank/i18n/it.i18n.json","telescope-email//Users/sacha/Dev/Telescope/packages/telescope-blank/i18n/zh-CN.i18n.json"],"names":[],"mappings":";;;;;;;;;AACA,6C;;AAEA,qF;AACA,wC;AACA,kE;AACA,0C;AACA,uD;AACA,U;AACA,2F;AACA,0C;AACA,G;AACA,C;;AAEA,6C;;AAEA,yB;AACA,sD;AACA,sD;AACA,kC;AACA,mC;AACA,0B;AACA,sB;AACA,oB;AACA,wC;AACA,sC;AACA,mC;AACA,yC;AACA,sC;AACA,G;;AAEA,qF;;AAEA,kD;AACA,mC;AACA,wB;AACA,4B;AACA,iC;AACA,yB;AACA,O;AACA,Y;;AAEA,wH;AACA,E;AACA,6B;AACA,C;;AAEA,8C;;AAEA,oC;AACA,uD;AACA,E;AACA,+D;AACA,qC;AACA,0C;;AAEA,kC;AACA,4F;AACA,4C;AACA,qB;AACA,O;AACA,G;;AAEA,yC;AACA,6B;AACA,yB;AACA,mC;AACA,gC;AACA,gC;;AAEA,e;AACA,gB;AACA,Y;AACA,sB;AACA,e;AACA,c;AACA,G;;AAEA,oB;;AAEA,e;AACA,E;;AAEA,kE;AACA,wE;AACA,uC;AACA,C;;AAEA,gB;AACA,0B;AACA,iC;AACA,0H;AACA,K;AACA,G;AACA,E;;;;;;;;;;;;;;;;;;AC9FA,4B;;AAEA,mB;;AAEA,wC;AACA,oB;AACA,oB;AACA,wB;AACA,sD;AACA,6B;AACA,wC;AACA,mC;AACA,Q;AACA,+D;AACA,oD;AACA,0B;AACA,K;AACA,K;;AAEA,mB;;AAEA,wC;AACA,oB;AACA,oB;AACA,wB;AACA,+C;AACA,4B;AACA,mB;AACA,yE;AACA,c;AACA,wC;AACA,O;AACA,oD;AACA,0B;AACA,K;AACA,K;;;AAGA,G;;;;;;;;;;;;;;;;;;ACtCA,0f;;;;;;;;;;;;;;;;;;ACAA,8mB;;;;;;;;;;;;;;;;;;ACAA,spB;;;;;;;;;;;;;;;;;;ACAA,4rB;;;;;;;;;;;;;;;;;;ACAA,wpB;;;;;;;;;;;;;;;;;;ACAA,mc;;;;;;;;;;;;;;;;;;ACAA,6Z;;;;;;;;;;;;;;;;;;ACAA,2tJ;;;;;;;;;;;;;;;;;;ACAA,6B;AACA,6B;AACA,0B;;AAEA,gC;AACA,yD;AACA,C;AACA,qE;AACA,+G;AACA,sE;AACA,+C;AACA,kC;AACA,C;;AAEA,0D;AACA,6C;AACA,C;;AAEA,0F;;;;;;;;;;;;;;;;;;;AClBA,6B;AACA,6B;AACA,0B;;AAEA,gC;AACA,yD;AACA,C;AACA,gD;AACA,qF;;;;;;;;;;;;;;;;;;;ACRA,6B;AACA,6B;AACA,0B;;AAEA,gC;AACA,yD;AACA,C;AACA,8E;AACA,+C;AACA,kC;AACA,C;;AAEA,0D;AACA,6C;AACA,C;;AAEA,0F;;;;;;;;;;;;;;;;;;;AChBA,6B;AACA,6B;AACA,0B;;AAEA,gC;AACA,yD;AACA,C;AACA,+E;AACA,+C;AACA,kC;AACA,C;;AAEA,0D;AACA,6C;AACA,C;;AAEA,0F;;;;;;;;;;;;;;;;;;;AChBA,6B;AACA,6B;AACA,0B;;AAEA,gC;AACA,yD;AACA,C;AACA,uE;AACA,+C;AACA,kC;AACA,C;;AAEA,0D;AACA,6C;AACA,C;;AAEA,0F;;;;;;;;;;;;;;;;;;;AChBA,6B;AACA,6B;AACA,0B;;AAEA,gC;AACA,yD;AACA,C;AACA,qE;AACA,kD;AACA,qC;AACA,C;;AAEA,6D;AACA,gD;AACA,C;;AAEA,6F","sourcesContent":["\nvar htmlToText = Npm.require('html-to-text');\n\n// check if server-side template has been customized, and return the correct template\ngetEmailTemplate = function (template) {\n  var emailTemplate = Handlebars.templates[getTemplate(template)];\n  if(typeof emailTemplate === 'function'){\n    return Handlebars.templates[getTemplate(template)];\n  } else {\n    console.log('Cannot find template '+getTemplate(template)+', defaulting to '+template);\n    return Handlebars.templates[template];\n  }\n}\n\nbuildEmailTemplate = function (htmlContent) {\n\n  var emailProperties = {\n    headerColor: getSetting('headerColor', '#444444'),\n    buttonColor: getSetting('buttonColor', '#DD3416'),\n    siteName: getSetting('title'),\n    tagline: getSetting('tagline'),\n    siteUrl: getSiteUrl(),\n    body: htmlContent,\n    unsubscribe: '',\n    accountLink: getSiteUrl()+'account',\n    footer: getSetting('emailFooter'),\n    logoUrl: getSetting('logoUrl'),\n    logoHeight: getSetting('logoHeight'),\n    logoWidth: getSetting('logoWidth')\n  }\n\n  var emailHTML = Handlebars.templates[getTemplate('emailWrapper')](emailProperties);\n\n  var inlinedHTML = Async.runSync(function(done) {\n    juice.juiceContent(emailHTML, {\n      url: getSiteUrl(),\n      removeStyleTags: false\n    }, function (error, result) {\n      done(null, result);\n    });\n  }).result;\n\n  var doctype = '<!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">'\n  \n  return doctype+inlinedHTML;\n}\n\nsendEmail = function(to, subject, html, text){\n\n  // TODO: limit who can send emails\n  // TODO: fix this error: Error: getaddrinfo ENOTFOUND\n  \n  var from = getSetting('defaultEmail', 'noreply@example.com');\n  var siteName = getSetting('title');\n  var subject = '['+siteName+'] '+subject;\n\n  if (typeof text == 'undefined'){\n    // Auto-generate text version if it doesn't exist. Has bugs, but should be good enough. \n    var text = htmlToText.fromString(html, {\n        wordwrap: 130\n    });\n  }\n\n  console.log('//////// sending email…');\n  console.log('from: '+from);\n  console.log('to: '+to);\n  console.log('subject: '+subject);\n  // console.log('html: '+html);\n  // console.log('text: '+text);\n\n  var email = {\n    from: from, \n    to: to, \n    subject: subject, \n    text: text,\n    html: html\n  }\n\n  Email.send(email);\n\n  return email;\n};\n\nbuildAndSendEmail = function (to, subject, template, properties) {\n  var html = buildEmailTemplate(getEmailTemplate(template)(properties));\n  return sendEmail (to, subject, html);\n}\n\nMeteor.methods({\n  testEmail: function () {\n    if(isAdminById(this.userId)){\n      var email = buildAndSendEmail (getSetting('defaultEmail'), 'Telescope email test', 'emailTest', {date: new Date()});\n    }\n  }\n})","Meteor.startup(function () {\n\n  // New user email\n\n  Router.route('/email/new-user/:id?', {\n    name: 'newUser',\n    where: 'server',\n    action: function() {\n      var user = Meteor.users.findOne(this.params.id);\n      var emailProperties = {\n        profileUrl: getProfileUrl(user),\n        username: getUserName(user)\n      };\n      html = getEmailTemplate('emailNewUser')(emailProperties);\n      this.response.write(buildEmailTemplate(html));\n      this.response.end();\n    }\n  });\n\n  // New post email\n\n  Router.route('/email/new-post/:id?', {\n    name: 'newPost',\n    where: 'server',\n    action: function() {\n      var post = Posts.findOne(this.params.id);\n      console.log(templates)\n      if (!!post) {\n        html = getEmailTemplate('emailNewPost')(getPostProperties(post));\n      } else {\n        html = \"<h3>No post found.</h3>\"\n      }\n      this.response.write(buildEmailTemplate(html));\n      this.response.end();\n    }\n  });\n\n\n});","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<span class=\\\"heading\\\">{{username}}, welcome to {{siteTitle}}!</span><br><br>\\n\\nYou've just been invited. <a href=\\\"{{siteUrl}}\\\">Start posting</a>.<br><br>\");Handlebars.templates[\"emailAccountApproved\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailAccountApproved\"});};","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<span class=\\\"heading\\\">\\n<a href=\\\"{{profileUrl}}\\\">{{invitedBy}}</a>\\ninvited you to join {{communityName}}\\n</span><br><br>\\n\\n{{#if newUser}}\\n<a href=\\\"{{actionLink}}\\\">Join {{communityName}}</a>\\n{{else}}\\n<a href=\\\"{{actionLink}}\\\">Sign in to {{communityName}}</a>\\n{{/if}}\\n<br><br>\\n\");Handlebars.templates[\"emailInvite\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailInvite\"});};","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<span class=\\\"heading\\\">\\n<a href=\\\"{{profileUrl}}\\\">{{comment.author}}</a>\\nleft a new comment on \\n<a href=\\\"{{postLink}}\\\" class=\\\"action-link\\\">{{post.title}}</a>:\\n</span>\\n<br/><br/>\\n\\n<div class=\\\"comment-body\\\">\\n{{{body}}}\\n</div>\\n<br>\\n\\n<a href=\\\"{{postCommentUrl}}\\\" class=\\\"action-link\\\">Discuss</a><br/><br/>\");Handlebars.templates[\"emailNewComment\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailNewComment\"});};","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<span class=\\\"heading\\\">\\n<a href=\\\"{{profileUrl}}\\\">{{postAuthorName}}</a>\\nhas created a new post:\\n{{#if url}}\\n  <a href=\\\"{{linkUrl}}\\\" class=\\\"action-link\\\">{{postTitle}}}</a>\\n{{else}}\\n  {{postTitle}}}\\n{{/if}}\\n</span><br><br>\\n\\n{{#if body}}\\n  <div class=\\\"post-body\\\">\\n  {{{body}}}\\n  </div>\\n  <br>\\n{{/if}}\\n\\n<a href=\\\"{{postUrl}}\\\">Discuss</a><br><br>\");Handlebars.templates[\"emailNewPost\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailNewPost\"});};","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<span class=\\\"heading\\\"><a href=\\\"{{profileUrl}}\\\">{{comment.author}}</a>\\nhas replied to your comment on\\n<a href=\\\"{{postLink}}\\\" class=\\\"action-link\\\">{{post.title}}</a>:\\n</span>\\n<br/><br/>\\n\\n<div class=\\\"comment-body\\\">\\n{{{body}}}\\n</div>\\n<br>\\n\\n<a href=\\\"{{postCommentUrl}}\\\" class=\\\"action-link\\\">Discuss</a><br/><br/>\");Handlebars.templates[\"emailNewReply\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailNewReply\"});};","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<span class=\\\"heading\\\">A new user account has been created: <a href=\\\"{{profileUrl}}\\\">{{username}}</a></span><br><br>\");Handlebars.templates[\"emailNewUser\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailNewUser\"});};","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<span class=\\\"heading\\\">This is just a test</span><br><br>\\n\\nSent at {{date}}.<br><br>\");Handlebars.templates[\"emailTest\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailTest\"});};","Handlebars = Handlebars || {};Handlebars.templates = Handlebars.templates || {} ;var template = OriginalHandlebars.compile(\"<html lang=\\\"en\\\">\\n<head>\\n    <meta http-equiv=\\\"Content-Type\\\" content=\\\"text/html; charset=UTF-8\\\">\\n    <meta name=\\\"viewport\\\" content=\\\"initial-scale=1.0\\\">    <!-- So that mobile webkit will display zoomed in -->\\n    <meta name=\\\"format-detection\\\" content=\\\"telephone=no\\\"> <!-- disable auto telephone linking in iOS -->\\n\\n    <title>{{siteName}}</title>\\n    <style type=\\\"text/css\\\">\\n\\n        /* Resets: see reset.css for details */\\n        .ReadMsgBody { width: 100%; background-color: #ebebeb;}\\n        .ExternalClass {width: 100%; background-color: #ebebeb;}\\n        .ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div {line-height:100%;}\\n        body {-webkit-text-size-adjust:none; -ms-text-size-adjust:none;}\\n        body {margin:0; padding:0;}\\n        table {border-spacing:0;}\\n        table td {border-collapse:collapse;}\\n        .yshortcuts a {border-bottom: none !important;}\\n\\n\\n        /* Constrain email width for small screens */\\n        @media screen and (max-width: 600px) {\\n            table[class=\\\"container\\\"] {\\n                width: 95% !important;\\n            }\\n            .main-container{\\n              font-size: 14px !important;\\n            }\\n        }\\n\\n        /* Give content more room on mobile */\\n        @media screen and (max-width: 480px) {\\n            td[class=\\\"container-padding\\\"] {\\n                padding-left: 12px !important;\\n                padding-right: 12px !important;\\n            }\\n        }\\n        a{\\n          color: {{buttonColor}};\\n          font-weight: bold;\\n          text-decoration: none;\\n        }\\n        .wrapper{\\n          padding: 20px 0;\\n        }\\n        .container{\\n          border-radius: 3px;\\n        }\\n        .heading-container{\\n          background: {{headerColor}};\\n          padding: 15px;\\n          text-align: center;\\n          border-radius: 3px 3px 0px 0px;\\n        }\\n        .heading-container, .logo{\\n          text-align: center;\\n          color: white;\\n          font-family: Helvetica, sans-serif;\\n          font-weight: bold;\\n          font-size: 20px;          \\n        }\\n        .main-container{\\n          line-height: 1.7;\\n          background: white;\\n          padding: 0 30px;\\n          font-size: 15px;\\n          font-family: Helvetica, sans-serif;\\n          color: #555;\\n        }\\n        .heading{\\n          font-weight: bold;\\n          font-size: 18px;\\n          line-height: 1.5;\\n          margin: 0;\\n        }\\n        .footer-container{\\n          background: #ddd;\\n          font-family: Helvetica, sans-serif;\\n          padding: 30px;\\n          color: #777;\\n          border-radius: 0px 0px 3px 3px;\\n          font-size: 13px;\\n        }\\n        .post-thumbnail{\\n          height: 28px;\\n          width: 37px;\\n          vertical-align: top;\\n        }\\n        .post-body, .comment-body{\\n          border-top: 1px solid #ddd;\\n          border-bottom: 1px solid #ddd;\\n          padding: 10px 0;\\n        }\\n    </style>\\n</head>\\n<body style=\\\"margin:0; padding:10px 0;\\\" bgcolor=\\\"#ebebeb\\\" leftmargin=\\\"0\\\" topmargin=\\\"0\\\" marginwidth=\\\"0\\\" marginheight=\\\"0\\\">\\n\\n<br>\\n\\n<!-- 100% wrapper (grey background) -->\\n<table border=\\\"0\\\" width=\\\"100%\\\" height=\\\"100%\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\" bgcolor=\\\"#ebebeb\\\">\\n  <tr>\\n    <td class=\\\"wrapper\\\" align=\\\"center\\\" valign=\\\"top\\\" bgcolor=\\\"#ebebeb\\\" style=\\\"background-color: #ebebeb;\\\">\\n\\n      <!-- 600px container (white background) -->\\n      <table border=\\\"0\\\" width=\\\"600\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\" class=\\\"container\\\" bgcolor=\\\"#ffffff\\\">\\n        <tr>\\n          <td class=\\\"heading-container\\\">\\n            {{#if logoUrl}}\\n              <img class=\\\"logo\\\" src=\\\"{{logoUrl}}\\\" height=\\\"{{logoHeight}}\\\" width=\\\"{{logoWidth}}\\\" alt=\\\"{{siteName}}\\\"/>\\n            {{else}}\\n              {{siteName}}\\n            {{/if}}\\n          </td>\\n        </tr>\\n        <tr>\\n          <td class=\\\"main-container container-padding\\\" bgcolor=\\\"#ffffff\\\">\\n            <br>\\n\\n            {{{body}}}\\n\\n          </td>\\n        </tr>\\n        <tr>\\n          <td class=\\\"footer-container\\\">\\n            <a href=\\\"{{accountLink}}\\\">Change your notifications settings</a><br/><br/>\\n            {{{footer}}}\\n          </td>\\n        </tr>\\n      </table>\\n      <!--/600px container -->\\n\\n    </td>\\n  </tr>\\n</table>\\n<!--/100% wrapper-->\\n<br>\\n<br>\\n</body>\\n</html>\\n\");Handlebars.templates[\"emailWrapper\"] = function (data, partials) { partials = (partials || {});return template(data || {}, { helpers: OriginalHandlebars.helpers,partials: partials,name: \"emailWrapper\"});};","var _ = Package.underscore._,\n    package_name = \"project\",\n    namespace = \"project\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nTAPi18n.languages_available_for_project[\"de\"] = [\"German\",\"Deutsch\"];\nTAPi18n._enable({\"helper_name\":\"_\",\"supported_languages\":null,\"i18n_files_route\":\"/tap-i18n\",\"cdn_path\":null});\nTAPi18n.languages_available_for_project[\"en\"] = [\"English\",\"English\"];\nif(_.isUndefined(TAPi18n.translations[\"de\"])) {\n  TAPi18n.translations[\"de\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"de\"][namespace])) {\n  TAPi18n.translations[\"de\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"de\"][namespace], {\"translation_key\":\"translation string\"});\n","var _ = Package.underscore._,\n    package_name = \"project\",\n    namespace = \"project\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\n// integrate the fallback language translations \nTAPi18n.addResourceBundle(\"en\", namespace, {\"translation_key\":\"translation string\"});\n","var _ = Package.underscore._,\n    package_name = \"project\",\n    namespace = \"project\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nTAPi18n.languages_available_for_project[\"es\"] = [\"Spanish (Spain)\",\"Español\"];\nif(_.isUndefined(TAPi18n.translations[\"es\"])) {\n  TAPi18n.translations[\"es\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"es\"][namespace])) {\n  TAPi18n.translations[\"es\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"es\"][namespace], {\"translation_key\":\"translation string\"});\n","var _ = Package.underscore._,\n    package_name = \"project\",\n    namespace = \"project\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nTAPi18n.languages_available_for_project[\"fr\"] = [\"French (France)\",\"Français\"];\nif(_.isUndefined(TAPi18n.translations[\"fr\"])) {\n  TAPi18n.translations[\"fr\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"fr\"][namespace])) {\n  TAPi18n.translations[\"fr\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"fr\"][namespace], {\"translation_key\":\"translation string\"});\n","var _ = Package.underscore._,\n    package_name = \"project\",\n    namespace = \"project\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nTAPi18n.languages_available_for_project[\"it\"] = [\"Italian\",\"Italiano\"];\nif(_.isUndefined(TAPi18n.translations[\"it\"])) {\n  TAPi18n.translations[\"it\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"it\"][namespace])) {\n  TAPi18n.translations[\"it\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"it\"][namespace], {\"translation_key\":\"translation string\"});\n","var _ = Package.underscore._,\n    package_name = \"project\",\n    namespace = \"project\";\n\nif (package_name != \"project\") {\n    namespace = TAPi18n.packages[package_name].namespace;\n}\nTAPi18n.languages_available_for_project[\"zh-CN\"] = [\"zh-CN\",\"zh-CN\"];\nif(_.isUndefined(TAPi18n.translations[\"zh-CN\"])) {\n  TAPi18n.translations[\"zh-CN\"] = {};\n}\n\nif(_.isUndefined(TAPi18n.translations[\"zh-CN\"][namespace])) {\n  TAPi18n.translations[\"zh-CN\"][namespace] = {};\n}\n\n_.extend(TAPi18n.translations[\"zh-CN\"][namespace], {\"translation_key\":\"translation string\"});\n"]}